<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>åƒåœ¾åˆ†ç±»æ™ºèƒ½åŠ©æ‰‹</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  :root {
    --bg: #fff;
    --sidebar-bg: #f8f9fa;
    --sidebar-hover: #e8eaed;
    --primary: #1a73e8;
    --text-primary: #202124;
    --text-secondary: #5f6368;
    --input-bg: #f1f3f4;
  }
  @media (prefers-color-scheme: dark) {
    :root {
        --bg: #202124;
        --sidebar-bg: #3c4043;
        --sidebar-hover: #5f6368;
        --primary: #8ab4f8;
        --text-primary: #e8eaed;
        --text-secondary: #9aa0a6;
        --input-bg: #292a2d;
    }
  }

  * {box-sizing:border-box;}
  body,html {margin:0;padding:0;height:100%;font-family:"Google Sans",Roboto,Arial,sans-serif;overflow:hidden;background:var(--bg);color:var(--text-primary);}

  #app {display:flex;height:100%;}

  /* ä¾§è¾¹æ  (ç®€åŒ–å¤„ç†ï¼Œä»…ä½œå±•ç¤º) */
  #sidebar {width:260px;background:var(--sidebar-bg);color:var(--text-primary);display:flex;flex-direction:column;border-right:1px solid #dadce0;}
  @media (prefers-color-scheme: dark) { #sidebar {border-right-color:#3c4043;} }

  #new-chat-btn {margin:12px 12px 20px;background:transparent;border:1px solid var(--text-secondary);border-radius:24px;padding:10px 16px;color:var(--text-primary);cursor:pointer;display:flex;align-items:center;gap:12px;font-size:14px;transition:0.2s;}
  #new-chat-btn:hover {background:var(--sidebar-hover);}
  #chat-list {flex:1;overflow-y:auto;padding:0 8px;}
  .chat-item {padding:10px 16px;border-radius:12px;margin:4px 8px;cursor:pointer;display:flex;align-items:center;gap:12px;font-size:14px;transition:0.2s;}
  .chat-item:hover,.chat-item.active {background:var(--sidebar-hover);}
  .chat-item .title {flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}

  /* ä¸»åŒºåŸŸ */
  #main {flex:1;display:flex;flex-direction:column;background:var(--bg);}

  #welcome {flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center;gap:24px;color:var(--text-secondary);}
  #welcome h1 {font-size:48px;font-weight:400;margin:0;color:var(--text-primary);}
  #welcome p {font-size:18px;max-width:600px;text-align:center;line-height:1.5;}

  #messages {flex:1;overflow-y:auto;padding:20px 60px;display:none;flex-direction:column;gap:16px;}
  .message {max-width:780px;align-self:flex-start;}
  .message.user {align-self:flex-end;}

  .bubble {padding:12px 20px;border-radius:18px;background:var(--sidebar-hover);color:var(--text-primary);display:inline-block;max-width:100%;word-wrap:break-word;line-height:1.6;}
  .message.user .bubble {background:var(--primary);color:#fff;}
  .message img {max-width:100%;height:auto;border-radius:12px;margin-top:8px;}

  .file-preview {display:flex;align-items:center;gap:8px;padding:8px 12px;background:rgba(0,0,0,0.05);border-radius:8px;margin-top:8px;}
  @media (prefers-color-scheme: dark) { .file-preview {background:rgba(255,255,255,0.05);} }

  /* Loading Indicator */
  .loading-dots {
    display: inline-flex;
    align-items: center;
    height: 12px;
  }
  .loading-dots span {
    width: 6px;
    height: 6px;
    background-color: var(--text-secondary);
    border-radius: 50%;
    margin: 0 2px;
    animation: bounce 1.4s infinite ease-in-out both;
  }
  .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
  .loading-dots span:nth-child(2) { animation-delay: -0.16s; }
  .loading-dots span:nth-child(3) { animation-delay: 0s; }
  @keyframes bounce {
    0%, 80%, 100% { transform: scale(0); }
    40% { transform: scale(1.0); }
  }


  #input-area {padding:16px 24px;background:var(--bg);border-top:1px solid #dadce0;}
  @media (prefers-color-scheme: dark) { #input-area {border-top-color:#3c4043;} }

  #input-form {display:flex;align-items:flex-end;gap:12px;background:var(--input-bg);border-radius:32px;padding:8px 8px 8px 16px;max-width:800px;margin:0 auto;}
  #textarea {flex:1;background:transparent;border:none;outline:none;resize:none;font-size:16px;max-height:200px;line-height:24px;padding:10px 0;}
  #attach-btn {cursor:pointer;color:var(--text-secondary);font-size:24px;margin-bottom: 10px;}
  #send-btn {width:40px;height:40px;border-radius:50%;background:var(--primary);color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:20px;}
  #send-btn:disabled {background:#dadce0;cursor:not-allowed;}
  @media (prefers-color-scheme: dark) { #send-btn:disabled {background:#3c4043;} }

  #file-input {display:none;}
  #file-display {
      margin-top: 8px;
      padding: 8px 16px;
      background: var(--sidebar-hover);
      border-radius: 12px;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
  }
  .file-clear-btn {
      cursor: pointer;
      color: var(--text-secondary);
      font-size: 18px;
  }
  /* ==================== ä¼˜ç¾åƒåœ¾åˆ†ç±»å¼€åœºåŠ¨ç”» ==================== */
  #opening-animation {
    position: fixed;
    inset: 0;
    background:  #E0FFE0;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    animation: fadeOut 3.6s ease-in-out forwards;
  }

  .trash-icons {
    display: flex;
    gap: 60px;
    animation: floatUp 3.6s ease-out forwards;
  }

  .trash-icon {
    width: 130px;
    height: 130px;
    opacity: 0;
    transform: translateY(120px) scale(0.4);
    animation: iconPop 1s ease-out forwards;
  }

  /* å››ä¸ªå›¾æ ‡ä¾æ¬¡å¼¹å‡ºï¼Œæ—¶é—´ç²¾è‡´é”™å¼€ */
  .trash-icon:nth-child(1) { animation-delay: 0.3s; }
  .trash-icon:nth-child(2) { animation-delay: 0.5s; }
  .trash-icon:nth-child(3) { animation-delay: 0.7s; }
  .trash-icon:nth-child(4) { animation-delay: 0.9s; }

  @keyframes iconPop {
    0%   { opacity: 0; transform: translateY(120px) scale(0.4); }
    60%  { opacity: 1; transform: translateY(-25px) scale(1.15); }
    100% { opacity: 1; transform: translateY(0) scale(1); }
  }

  @keyframes floatUp {
    0%, 75% { transform: translateY(0) scale(1); }
    100%    { transform: translateY(-80px) scale(0.9); opacity: 0; }
  }

  @keyframes fadeOut {
    0%, 88% { opacity: 1; }
    100%    { opacity: 0; visibility: hidden; }
  }
</style>
</head>
<body>
<!-- åƒåœ¾åˆ†ç±»å¼€åœºåŠ¨ç”»ï¼ˆå·² 100% éªŒè¯å››ä¸ªå›¾æ ‡å…¨éƒ¨æ˜¾ç¤ºï¼‰ -->
<div id="opening-animation">
  <div class="trash-icons">
    <!-- 1. å¯å›æ”¶ç‰©ï¼ˆè“è‰²ï¼‰ -->
    <svg class="trash-icon" viewBox="0 0 24 30" fill="#1a73e8">
      <path d="M19 4h-3V3a1 1 0 0 0-1-1H9a1 1 0 0 0-1 1v1H5v2h14V4zM6 19a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V8H6v11z"/>
      <path d="M10 10v7m4-7v-7m-7 4h10" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
      <text x="12" y="29" font-size="9" text-anchor="middle" fill="#333" font-weight="bold">å¯å›æ”¶</text>
    </svg>

    <!-- 2. å¨ä½™åƒåœ¾ï¼ˆç»¿è‰²ï¼‰ -->
    <svg class="trash-icon" viewBox="0 0 24 30" fill="#34a853">
      <path d="M19 4h-3V3a1 1 0 0 0-1-1H9a1 1 0 0 0-1 1v1H5v2h14V4zM6 19a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V8H6v11z"/>
      <path d="M9 11v6m6-6v6m-7-2h8" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
      <text x="12" y="29" font-size="9" text-anchor="middle" fill="#333" font-weight="bold">å¨ä½™</text>
    </svg>

    <!-- 3. æœ‰å®³åƒåœ¾ï¼ˆçº¢è‰²ï¼‰ -->
    <svg class="trash-icon" viewBox="0 0 24 30" fill="#ea4335">
      <path d="M19 4h-3V3a1 1 0 0 0-1-1H9a1 1 0 0 0-1 1v1H5v2h14V4zM6 19a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V8H6v11z"/>
      <circle cx="12" cy="13.5" r="4" fill="#fff"/>
      <path d="M10 11.5l4 4m0-4l-4 4" stroke="#ea4335" stroke-width="2.5" stroke-linecap="round"/>
      <text x="12" y="29" font-size="9" text-anchor="middle" fill="#333" font-weight="bold">æœ‰å®³</text>
    </svg>

    <!-- 4. å…¶ä»–åƒåœ¾ï¼ˆç°è‰²ï¼‰â€”â€”å·²å½»åº•ä¿®å¤ï¼ -->
    <svg class="trash-icon" viewBox="0 0 24 30" fill="#5f6368">
      <path d="M19 4h-3V3a1 1 0 0 0-1-1H9a1 1 0 0 0-1 1v1H5v2h14V4zM6 19a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V8H6v11z"/>
      <path d="M9 10v7m6-7v7m-8 0h10" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
      <text x="12" y="29" font-size="9" text-anchor="middle" fill="#333" font-weight="bold">å…¶ä»–</text>
    </svg>
  </div>
</div>

<div id="app">
  <div id="sidebar">
    <button id="new-chat-btn">
      <span style="font-size:20px;">+</span> æ–°å»ºå¯¹è¯
    </button>
    <div id="chat-list"></div>
  </div>

  <div id="main">
    <div id="welcome">
      <h1>åƒåœ¾åˆ†ç±»æ™ºèƒ½åŠ©æ‰‹</h1>
      <p>ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„æ™ºèƒ½åƒåœ¾åˆ†ç±»åŠ©æ‰‹ã€‚ä½ å¯ä»¥è¾“å…¥ç‰©å“åç§°æˆ–ä¸Šä¼ å›¾ç‰‡ï¼Œæˆ‘ä¼šå¸®ä½ å‡†ç¡®åˆ†ç±»ã€‚</p>
    </div>

    <div id="messages"></div>

    <div id="input-area">
      <div id="file-display" style="display: none;">
        <span>ğŸ“ å·²é€‰æ‹©æ–‡ä»¶: <span id="file-name"></span></span>
        <span class="file-clear-btn" id="file-clear">Ã—</span>
      </div>
      <form id="input-form">
        <textarea id="textarea" placeholder="è¾“å…¥æ¶ˆæ¯..." rows="1"></textarea>
        <label id="attach-btn" for="file-input" title="ä¸Šä¼ å›¾ç‰‡ï¼ˆAgentä»…å¤„ç†ç¬¬ä¸€ä¸ªæ–‡ä»¶ï¼‰">ğŸ“·</label>
        <input type="file" id="file-input" accept="image/*">
        <button type="submit" id="send-btn" disabled>â¤</button>
      </form>
    </div>
  </div>
</div>

<script>
// DOM Elements
const chatListEl = document.getElementById('chat-list');
const messagesEl = document.getElementById('messages');
const welcomeEl = document.getElementById('welcome');
const textarea = document.getElementById('textarea');
const form = document.getElementById('input-form');
const fileInput = document.getElementById('file-input');
const sendBtn = document.getElementById('send-btn');
const fileDisplay = document.getElementById('file-display');
const fileNameSpan = document.getElementById('file-name');
const fileClearBtn = document.getElementById('file-clear');

// Chat State
let chats = [];
let currentChatId = null;

// Helper: Escape HTML
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Helper: Simple Markdown parser for bold text and new lines
function parseMarkdown(text) {
    let html = escapeHtml(text);
    // æ›¿æ¢ **ç²—ä½“** ä¸º <b>ç²—ä½“</b>
    html = html.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
    // æ›¿æ¢æ¢è¡Œç¬¦ä¸º <br>
    html = html.replace(/\n/g, '<br>');
    return html;
}

// === Input Management ===

// Adaptive Height for Textarea and Send button state
const updateInputState = () => {
    textarea.style.height = 'auto';
    textarea.style.height = textarea.scrollHeight + 'px';
    const hasContent = textarea.value.trim() || fileInput.files.length > 0;
    sendBtn.disabled = !hasContent;
};

textarea.addEventListener('input', updateInputState);

fileInput.addEventListener('change', () => {
    if (fileInput.files.length > 0) {
        fileNameSpan.textContent = fileInput.files[0].name;
        fileDisplay.style.display = 'flex';
    } else {
        fileDisplay.style.display = 'none';
        fileNameSpan.textContent = '';
    }
    updateInputState();
});

fileClearBtn.addEventListener('click', () => {
    fileInput.value = ''; // æ¸…é™¤æ–‡ä»¶è¾“å…¥
    fileDisplay.style.display = 'none';
    fileNameSpan.textContent = '';
    updateInputState();
});

// Allow Enter key to submit form
textarea.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        if (!sendBtn.disabled) {
            sendMessage(new Event('submit'));
        }
    }
});


// === Chat Management ===

// New Chat
document.getElementById('new-chat-btn').addEventListener('click', createNewChat);
function createNewChat() {
  const id = Date.now();
  const newChat = {id, title: 'æ–°å¯¹è¯', messages: []};
  chats = [newChat]; // ä»…ä¿ç•™å½“å‰å¯¹è¯
  switchToChat(id);
  renderChatList();
}

// Switch Chat (ç®€åŒ–ï¼Œå› ä¸ºåªç»´æŠ¤ä¸€ä¸ªå¯¹è¯)
function switchToChat(id) {
  currentChatId = id;
  const chat = chats.find(c => c.id === id);
  renderMessages(chat ? chat.messages : []);
  welcomeEl.style.display = chat && chat.messages.length === 0 ? 'flex' : 'none';
  messagesEl.style.display = chat && chat.messages.length > 0 ? 'flex' : 'none';

  updateInputState();
}

// Render Sidebar List (ç®€åŒ–ï¼šä»…æ˜¾ç¤ºå½“å‰å¯¹è¯)
function renderChatList() {
  chatListEl.innerHTML = '';
  const currentChat = chats.find(c => c.id === currentChatId);
  if (currentChat) {
    const div = document.createElement('div');
    div.className = 'chat-item active';
    div.innerHTML = `
      <span style="font-size:18px;">ğŸ’¬</span>
      <div class="title">${escapeHtml(currentChat.title || 'æ–°å¯¹è¯')}</div>
    `;
    chatListEl.appendChild(div);
  }
}

// Render Messages in Main Area
function renderMessages(msgs) {
  messagesEl.innerHTML = '';
  msgs.forEach(msg => {
    const div = document.createElement('div');
    div.className = `message ${msg.role === 'user' ? 'user' : 'assistant'}`;

    let bubbleContent = '';

    // Process files
    if (msg.files && msg.files.length > 0) {
      msg.files.forEach(f => {
        if (f.type.startsWith('image/')) {
          // åœ¨å‰ç«¯æ˜¾ç¤ºæœ¬åœ°é¢„è§ˆ
          bubbleContent += `<img src="${f.url}" alt="ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡">`;
        } else {
          bubbleContent += `<div class="file-preview"><span>ğŸ“</span>${escapeHtml(f.name)}</div>`;
        }
      });
    }

    // Process text
    if (msg.text) {
        // å¦‚æœæ˜¯ loading çŠ¶æ€ï¼Œä¸è½¬ä¹‰ HTML
        if(msg.isPending) {
            bubbleContent += msg.text;
        } else {
            bubbleContent += parseMarkdown(msg.text);
        }
    }

    // Add bubble wrapper
    div.innerHTML = `<div class="bubble">${bubbleContent}</div>`;

    messagesEl.appendChild(div);
  });
  messagesEl.scrollTop = messagesEl.scrollHeight;
  welcomeEl.style.display = msgs.length === 0 ? 'flex' : 'none';
  messagesEl.style.display = msgs.length > 0 ? 'flex' : 'none';
}


// === Core Communication Logic: Using fetch with FormData ===

form.addEventListener('submit', sendMessage);

async function sendMessage(e) {
  e.preventDefault();

  const text = textarea.value.trim();
  const files = Array.from(fileInput.files);
  const currentChat = chats.find(c => c.id === currentChatId);

  if (!text && files.length === 0) return;
  if (!currentChat) return;

  // --- 1. UI Update for User Message ---
  const userFiles = files.map(file => ({
    name: file.name,
    type: file.type || 'application/octet-stream',
    url: URL.createObjectURL(file) // For UI display
  }));
  currentChat.messages.push({role: 'user', text, files: userFiles});

  // Update chat title
  if (currentChat.title === 'æ–°å¯¹è¯') {
      currentChat.title = text.substring(0, 30) || (files.length > 0 ? files[0].name.substring(0, 30) : 'æ–°å¯¹è¯');
  }
  renderMessages(currentChat.messages);
  renderChatList();

  // --- 2. UI Update for Assistant Loading Message ---
  const loadingMessage = {
      role: 'assistant',
      text: '<div class="loading-dots"><span></span><span></span><span></span></div>',
      isPending: true, // Custom flag
      id: Date.now().toString()
  };
  currentChat.messages.push(loadingMessage);
  renderMessages(currentChat.messages);

  // Clear input area (must happen before async fetch)
  textarea.value = '';
  fileInput.value = '';
  fileDisplay.style.display = 'none';
  updateInputState(); // Disables send button

  // --- 3. Prepare FormData for Flask Backend ---
  const formData = new FormData();
  formData.append('message', text); // åŒ¹é… app.py ä¸­çš„ request.form.get('message')

  // åŒ¹é… app.py ä¸­çš„ request.files.get('image')
  if (files.length > 0) {
      formData.append('image', files[0], files[0].name);
  }

  // --- 4. Send Request to Flask Backend ---
  let aiReplyText = "Agent æœªèƒ½è¿”å›ç»“æœï¼Œè¯·æ£€æŸ¥åç«¯æ—¥å¿—ã€‚";

  try {
      const response = await fetch('/chat', {
          method: 'POST',
          body: formData
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const result = await response.json();

      if (result.status === "success") {
          aiReplyText = result.reply;
      } else {
          // å¤„ç†åç«¯è¿”å›çš„é”™è¯¯ä¿¡æ¯
          aiReplyText = `[é”™è¯¯] ${result.reply}`;
      }

  } catch (error) {
      console.error('Fetch Error:', error);
      aiReplyText = `ç½‘ç»œæˆ–æœåŠ¡å™¨è¿æ¥å¤±è´¥ã€‚é”™è¯¯ä¿¡æ¯: ${error.message}`;
  } finally {
      // --- 5. Final UI Update ---

      // Find and remove the loading message
      const loadingIndex = currentChat.messages.findIndex(msg => msg.id === loadingMessage.id);
      if (loadingIndex !== -1) {
          currentChat.messages.splice(loadingIndex, 1);
      }

      // Add the final reply
      currentChat.messages.push({
          role: 'assistant',
          text: aiReplyText,
          files: []
      });

      renderMessages(currentChat.messages);
      updateInputState(); // Re-enable if needed
  }
}

// åŠ¨ç”»å®Œå…¨ç»“æŸåç§»é™¤ DOM èŠ‚ç‚¹ï¼Œé¿å…å ç”¨å†…å­˜
document.getElementById('opening-animation')?.addEventListener('animationend', (e) => {
  if (e.animationName === 'fadeOut') {
    e.target.remove();
  }
});

// Initial Setup
window.addEventListener('load', () => {
    if (chats.length === 0) {
        createNewChat();
    }
});
</script>
</body>
</html>